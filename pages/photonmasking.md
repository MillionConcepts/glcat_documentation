# Photon Flagging: Flag Backplane 

## Photon-level Flagging 
Before the pipeline produces images, photons are flagged in-line and the flags are saved in the photonlist. These photon-level flags are then propagated into the flag backplane for both images and movies. 

### Hotspot and Coldspot Flags

Hotspots and coldspots are detector areas with very high or very low count rates compared to real stars thought to be caused by small debris or other defects on the MCP detectors. When an observation is projected into sky-coordinates, hotspots adopt the shape of the eclipse's dither pattern. Their spiral-shaped tracks can be bright to dim. Some hotspots and coldspots are recurring throughout the mission, and some hotspots and coldspots are intermittent or short-lived. We want to flag hotspots to avoid mistakenly identifying them as stars. Both hotspots and coldspots should be flagged to identify influences on correct photometry measurements. 

#### Original Mission Mask 
 
The original mission pipeline used binary masks in generated for each band in detector space. We think they were hand-drawn from observed hotspots in multiple dose images. These masks do not change between observations and therefore work well for masking recurring hotspots and coldspots. Photons are flagged using their position in detector space to apply their band-specific mask. Because the mission masks are not comprehensive, one can also check the dispersion (SIGDISP) photometry column and the count and dose map images for a pattern inverse to that of stars. 

```{image} figures/missionmasks.png
:alt: ogmissionmasks
:width: 800px
:align: center
```
*Figure: Binary masks for hotspots and coldspots generated by the mission.*

### Detector Edge Flags 

Closer to the detector edge, image quality degrades. At the detector edge: 
* The effective exposure time at the edge of the detector is lower than at the center.
* The detector gain is lower than at the center and tend to saturate more quickly. 
* Degraded PSF (larger) at the edge than at the center. 
* Spatial nonlinearity (distortion) due to high-voltage detector edge effects. 

We flag photons based on their proximity to the detector edge. 'Detrad' is calculated as the distance from the center of the detector using each photon's column and row values, where the maximum detrad value is ~400. There are two detector edge photon flags: the narrow edge and wide edge flag. The narrow and wide edge flags are for photons greater than 370 and 350 detrad, respectively. Because these flags are applied in detector-space, they do not have a smooth appearance in sky-projected space. For example, some wide edge flags may be further from the center of the image than narrow edge flags because of the observation's dither pattern. 

### Post-CSP "Ghost" Flags

Data quality significantly degraded late in the mission after a Coarse Sun Point (CSP) event in May 2010 (eclipse 37423) which caused pervasive streakiness in the images in the Y direction. The mission attributed the image quality degradation to the pho"partial failure of a capacitor associated with an A/D converter." By adjusting the time-to-amplitude-converter (TAC) a month later (eclipse 38149), the image quality improved. 

Some remaining streakiness was improved by applying a correction with photon YA values. Different walk and wiggle calibration files, as well as stim positions are also used for processing post-CSP eclipses. However, despite these improvements to the pipeline for post-CSP eclipses, some remaining photons are not position-corrected and appear as "ghosts" to the actual stars. These ghosts have a consistent offset accross the detector from their originating star along the detector Y axis. 

```{image} figures/cnt_e44405.png
:alt: e44405count
:width: 450px
:align: center
```
*Figure: Images with ghosts can look like you are "seeing double" of all the stars.*

We do not allow processing of eclipses post-CSP and before the TAC switch in gPhoton2 (37423 < bad eclipses < 38149). For eclipses after the TAC switch, we implement photon-level flagging of photons that may be part of a ghost. Ghost photons have lower average YA values than stars, as you can see in the image below. We bin photons on their ra and dec values, calculating the average YA value per bin, as well the photon count per bin. Photons in bins with mean YA values below 6 and photon counts above 15 are flagged as ghost photons. The ghost flag is then propagated to the flag backplanes for post-CSP eclipses. Aside from photon flagging for ghosts, we also run aperture photometry on a mean YA backplane for all stars (see {doc}`the page on alternative photometry columns <pages/alt_photom_cols>`). 


```{image} figures/exampleghosts.png
:alt: e44405ghosts
:width: 700px
:align: center
```
*Figure: Mean YA image showing the depressed YA values of ghosts relative to stars, most prominent for brighter stars. Ghosts are diagonally to the upper right of their origin star.*

