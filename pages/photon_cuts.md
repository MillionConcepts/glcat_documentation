# Photon Pipeline Corrections and Cuts 

## Not All Photons Make It Into Images and Movies

`gPhoton2` pulls all observational data from a visit's **raw6** file. The raw6 file contains more time-tagged photon events than end up in the final products (images, movies, photometry) output by `gPhoton2`. Many of these events are flagged due to being off-detector, having a bad aspect solution, or some other flag. Below, we outline most of the processing the observation event list undertakes from the **raw6** file format to the `gPhoton2` output photonlist. More thorough explanation of most steps can be found in Morrissey et al. 2007. 

"Bad" photons are flagged between most calibration steps after loading the raw6, and the flags propagate through the pipeline. This flagging system is largely borrowed from the original mission's pipeline flagging, and is separate from the *artifact flags* discussed elsewhere.

## Pipeline Steps 

1. **Load raw telemtry and center/scale photon events**
   - Opens and decodes a GALEX raw telemtry (.raw6) file. The main components pulled from the raw6 file are event location information (xb, xamc, yb, yamc, xa), time (t), and pulse height (q).  
   - Scales the raw photon positions from bins to microns using constants thT are based on the detector clock, center, scale, and slope values.  
   - These empirically determined calibration parameters define the relationship between raw event data and physical positions of events on the detector.  

2. **Create SSD from decoded raw6 data**: Collects stim events for all 4 stims in the detector corners and computes how the stims move over the observation. These stim separation diagnostics are used in later correction steps. 

3. **Y-axis Location Correction for Post-CSP Eclipses**: Uses calibration files for post-CSP eclipses to modify photon locations in the Y direction, reducing streakiness resulting from the CSP event. Only run on post-CSP eclipses (eclipses > 37423). 
   
4. **Photonlists Divided Into Legs:** Photonlists are divided into legs based on boresight table timestamps. The remaining processing is done leg by leg. 

5. **Apply On-Detector Corrections**  
- **`apply_wiggle_correction` & `wiggle_and_dig`** : Photons collected throughout an observation occur during different phases of the time-to-amplitude converter (TAC). Point sources can thus appear blurred in images by the superposition of all of the TAC data. This is called "wiggle." We correct for wiggle using lookup tables based on each event's $X_a$ value, which corresponds to its TAC phase. 
  - Flags photons as off detector with `flag 8` after `apply_wiggle_correction` and with `flag 9` after `wiggle_and_dig`.
- **`perform_spatial_nonlinearity_correction`**: Corrects for pulse height (Q) errors that result in incorrect photon positions, an effect called "walk." Uses a lookup table to correct x and y positions, orgaised by pulse height.
  - Flags photons off-detector after this correction with `flag 10`.
- **`compute_detector_orientation`**: A lookup table is used to correct photon positions in high-voltage areas near the edge of the detector which can distort the image.
- **`apply_stim_distortion_correction`**: Distortion of both NUV and FUV images are improved using lookup maps that shift photon locations for different ranges of stim separations. Additionally, the FUV offset is applied at this step. A shift in the x and y direction is applied to all photons based on lookup tables organized by eclipse number and the temperature of the FUV detector. 
  - `Flag 11` is applied in a helper function here but never passed on. 
- **`unfancy_detector_coordinates`**: Flips NUV and FUV data to have the same orientation and converts the "fancy" detector coordinates we have been applying corrections to to column and row values.
  - Column and row values outside of the range 0 - 799 are flagged as `flag 6`.
7. **Apply aspect solution**: Load aspect solution and interpolate, applying to all photons with valid aspect solutions.
  - `Flag 7` for all photons with any flag that is not `0` or `6` and with a time outside of the aspect solution temporal coverage.
  - `Flag 12` for any photon: without a valid preceding aspect solution, with an odd aspect flag (aspect flags are a separate flagging system stored in the aspect solution parquet and generated by the mission), or with a pre-existing flag of `7`.
  - At this point, all off the following flags are considered off-detector: 2, 5, 7, 8, 9, 10, 11, 12. Their aspect values (ra, dec, roll) are set to NaN.
8. **Inline calibration of photons**: Applies hotspot mask, detector flat and scale map (flat * scale = response map) to each photon.
9. **Flag Ghosts for Post-CSP Eclipses**: Only for eclipses after eclipse 37423, we add `flag 120` for photons in bins where low mean YA values indicate they may be post-CSP ghosts. Photons are binned into a 1600 x 1600 array by column and row values, and photons in bins where the mean YA value is <6 and there are >15 photons receive `flag 120`.

